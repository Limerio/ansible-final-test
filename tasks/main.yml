# SPDX-License-Identifier: MIT
---
- name: Load default variables
  ansible.builtin.include_vars: defaults/main.yml

- name: Load OS-specific variables
  ansible.builtin.include_vars: "vars/{{ ansible_facts['os_family'] }}.yml"

- name: Include preparation tasks
  ansible.builtin.include_tasks: prep.yml

- name: Include package installation
  ansible.builtin.include_tasks: packages.yml

- name: Clean up
  ansible.builtin.include_tasks: clean-up.yml

- name: Start Apache and MariaDB
  ansible.builtin.include_tasks: start.yml

- name: Wait for MariaDB to accept connections
  ansible.builtin.wait_for:
    port: 3306
    host: 127.0.0.1
    delay: 2
    timeout: 60
    state: started

- name: Secure MariaDB
  ansible.builtin.include_tasks: secure-mariadb.yml

- name: Create WordPress database
  ansible.builtin.include_tasks: create-database.yml

- name: Download WordPress
  ansible.builtin.include_tasks: download-wordpress.yml

- name: Create WordPress configuration
  ansible.builtin.include_tasks: create-configuration.yml

- name: Configure WordPress
  ansible.builtin.include_tasks: configure-wordpress.yml

- name: Restart Apache
  block:
    - name: Restart Apache via systemd/service
      ansible.builtin.service:
        name: "{{ wordpress_httpd_service }}"
        state: restarted
  rescue:
    - name: Restart Apache daemon (Rocky/RHEL container without systemd)
      when: ansible_facts['os_family'] == 'RedHat'
      ansible.builtin.command: /usr/sbin/apachectl restart
      changed_when: true
      failed_when: false
