# SPDX-License-Identifier: MIT
---
- name: Change the root password (try with current password for idempotency)
  ansible.builtin.command:
    cmd: mysql -uroot -p{{ mysql_root_password }} -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '{{ mysql_root_password }}';"
  register: root_pw_set
  failed_when: false

- name: Change the root password (first run â€“ no password set yet)
  ansible.builtin.command:
    cmd: mysql -uroot -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '{{ mysql_root_password }}';"
  when: root_pw_set is failed

- name: Delete anonymous users
  command: mysql -uroot -p{{ mysql_root_password }} -e "DELETE FROM mysql.user WHERE User='';"
- name: Delete test database
  shell: |
    mysql -uroot -p{{ mysql_root_password }} -e "DROP DATABASE IF EXISTS test;" 
    mysql -uroot -p{{ mysql_root_password }} -e "DELETE FROM mysql.db WHERE Db='test' OR 
    Db='test\\_%';"
- name: Flush privileges
  command: mysql -uroot -p{{ mysql_root_password }} -e "FLUSH PRIVILEGES;"
